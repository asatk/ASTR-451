/**
 * Definition of general physical constants as well as properties of a star
 * assumed true ubiquitously.
 * 
 * Author: Anthony Atkinson
 * Date: 2021-09-30
 */

#define NSPECIES 11

enum species {HYDROGEN, HELIUM, CARBON, SODIUM, MAGNESIUM, SILICON, POTASSIUM, CALCIUM,
    CHROMIUM, IRON, NICKEL};

double planck(double temp, double lambda);
double e1(double x);
double e2(double x);
double hjerting(double u, double a);

static double c = 2.998e10;    // speed of light, cm s-1
static double G = 6.674e-8;    // gravitational constant, ergs cm g-2
static double h = 6.626e-27;   // plancks constant, ergs s
static double k = 1.381e-16;   // boltzmann constant, ergs K-1
static double mu = 1.661e-24;  // atomic mass unit, g
static double me = 9.109e-28;  // electron mass, g
static double qe = 1.602e-19;  // electron charge, C
static double qeesu = 4.803e-10;    // electron charge in e.s.u.
// static double eps0 = 8.85e-12; // permittivity of free space (mks)
static double tsol = 5.777e3;  // effective temperature of the sun (Sol)
static double Ihminus = 0.754; // ionization energy of H- ion
static double a0 = 1.0449e-26; // for lambda in angstroms
static double R = 1.0968e-3;   // for lambda in angstroms

// these may be variable parameters... put in main and parse with line command
static double fosc = 0.6546;   // oscillator strength (f) used in natural broadening for this line
static double c4 = -15.17;     // log C4 constant for 
static double c6 = -31.7;      // log C6 constant for
static double gammanat = 7.9;  // log gamma (damping) for natural broadening

static char *speciesnames[25] = {
        "H-e- ", "e- ", "H- ", "H I", "H II",
        "He I", "He II", "C I", "C II",
        "Na I", "Na II", "Mg I", "Mg II",
        "Si I", "Si II", "K I", "K II",
        "Ca I", "Ca II", "Cr I", "Cr II",
        "Fe I", "Fe II", "Ni I", "Ni II"    
};

/**
 * ABUNDANCES (# atom/# hydrogen, in the Sun)
 * per Table 16.3 (Gray, 3ed)
 */
static double A[] = {
    1.00e+0,    //H
    8.51e-2,    //He
    3.31e-4,    //C
    2.14e-6,    //Na
    3.80e-5,    //Mg
    3.35e-5,    //Si
    1.32e-7,    //K
    2.29e-6,    //Ca
    4.68e-7,    //Cr
    2.75e-5,    //Fe
    1.78e-6     //Ni
};

/**
 * IONIZATIONS (eV for 1st ionization)
 * per Table D.1 (Gray, 3ed)
 */
static double I[] = {
    13.598,     //H
    24.587,     //He
    11.260,     //C
    5.139,      //Na
    7.646,      //Mg
    8.152,      //Si
    4.341,      //K
    6.113,      //Ca
    6.767,      //Cr
    7.902,      //Fe
    7.640       //Ni
};

/**
 * ATOMIC WEIGHTS (amu)
 * per Table D.1 (Gray, 3ed)
 */
static double amu[] = {
    1.008,      //H
    4.003,      //He
    12.011,     //C
    22.990,     //Na
    24.305,     //Mg
    28.086,     //Si
    39.10,      //K
    40.08,      //Ca
    51.996,     //Cr
    55.847,     //Fe
    58.71       //Ni
};

/**
 * Theta values corresponding to the tabulated partition function argument
 */
static double thetas[10] = {0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4, 1.6, 1.8, 2.0};

/**
 * PARTITION FUNCTIONS for NEUTRAL SPECIES
 * per Table D.2 (Gray, 3ed)
 */
static double u0[][10] = {
//   0.2    0.4    0.6    0.8    1.0    1.2    1.4    1.6    1.8    2.0
    {0.368, 0.303, 0.301, 0.301, 0.301, 0.301, 0.301, 0.301, 0.301, 0.301}, //H
    {0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000}, //He
    {1.163, 1.037, 0.994, 0.975, 0.964, 0.958, 0.954, 0.951, 0.950, 0.948}, //C
    {4.316, 1.043, 0.493, 0.357, 0.320, 0.309, 0.307, 0.306, 0.306, 0.306}, //Na
    {2.839, 0.478, 0.110, 0.027, 0.007, 0.002, 0.001, 0.001, 0.001, 0.000}, //Mg
    {1.521, 1.111, 1.030, 0.996, 0.976, 0.961, 0.949, 0.940, 0.932, 0.925}, //Si
    {4.647, 1.329, 0.642, 0.429, 0.351, 0.320, 0.308, 0.303, 0.302, 0.302}, //K
    {5.238, 1.332, 0.465, 0.181, 0.073, 0.028, 0.010, 0.003, 0.001, 0.000}, //Ca
    {4.284, 1.977, 1.380, 1.141, 1.022, 0.956, 0.917, 0.892, 0.875, 0.865}, //Cr
    {3.760, 2.049, 1.664, 1.519, 1.446, 1.402, 1.372, 1.350, 1.332, 1.317}, //Fe
    {2.779, 1.753, 1.577, 1.521, 1.490, 1.467, 1.447, 1.428, 1.410, 1.394}  //Ni
};

/**
 * PARTITION FUNCTIONS for SINGLY-IONIZIED SPECIES at theta=1.0
 * per Table D.2 (Gray, 3ed)
 */
static double u1[][10] = {
//   0.2    0.4    0.6    0.8    1.0    1.2    1.4    1.6    1.8    2.0
    {0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000}, //H+
    {0.301, 0.301, 0.301, 0.301, 0.301, 0.301, 0.301, 0.301, 0.301, 0.301}, //He+
    {0.853, 0.782, 0.775, 0.774, 0.773, 0.772, 0.771, 0.770, 0.769, 0.767}, //C+
    {0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000}, //Na+
    {0.537, 0.326, 0.304, 0.301, 0.301, 0.301, 0.301, 0.301, 0.301, 0.301}, //Mg+
    {0.900, 0.778, 0.764, 0.759, 0.755, 0.750, 0.746, 0.741, 0.736, 0.731}, //Si+
    {0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000}, //K+
    {0.825, 0.658, 0.483, 0.391, 0.344, 0.320, 0.309, 0.304, 0.302, 0.301}, //Ca+
    {1.981, 1.489, 1.125, 0.944, 0.856, 0.813, 0.793, 0.784, 0.781, 0.780}, //Cr+
    {2.307, 1.881, 1.749, 1.682, 1.638, 1.604, 1.575, 1.549, 1.525, 1.504}, //Fe+
    {1.659, 1.386, 1.215, 1.108, 1.037, 0.988, 0.953, 0.927, 0.908, 0.893}  //Ni+
};

/**
 * Locations of discontinuities in Hydrogen Bound-Free absorption - this is the
 * wavelength corresponding to the energy required to ionize Hydrogen for its
 * electron at a given level (in its principal quantum number, n). The listed
 * wavelengths are in Angstroms, starting from the Lyman jump, Balmer, Paschen,
 * Brachen, etc.
 * 
*/
static double contjumps[] = {911.8, 3.646e3, 8.204e3, 14.580e3, 22.79e3, 32.82e3};

// u-values as Hjerting parameter corresponding to the index in the below approx
static double hjertu[81] = {0., 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0,
    1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.0, 2.1, 2.2, 2.3, 2.4, 2.5,
    2.6, 2.7, 2.8, 2.9, 3.0, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8, 3.9, 4.0,
    4.2, 4.4, 4.6, 4.8, 5.0, 5.2, 5.4, 5.6, 5.8, 6.0, 6.2, 6.4, 6.6, 6.8, 7.0,
    7.2, 7.4, 7.6, 7.8, 8.0, 8.2, 8.4, 8.6, 8.8, 9.0, 9.2, 9.4, 9.6, 9.8, 10.0,
    10.2, 10.4, 10.6, 10.8, 11.0, 11.2, 11.4, 11.6, 11.8, 12.0};

// Coefficients for polynomial expansion of Hjerting function
static double hjert[5][81] = {
    // H0(u)
    {+1.000000,+0.990050,+0.960789,+0.913931,+0.852144,+0.778801,+0.697676,
    +0.612626,+0.527292,+0.444858,+0.367879,+0.298197,+0.236928,+0.184520,
    +0.140858,+0.105399,+0.077305,+0.055576,+0.039164,+0.027052,+0.0183156,
    +0.0121552,+0.0079071,+0.0050418,+0.0031511,+0.0019305,+0.0011592,
    +0.0006823,+0.0003937,+0.0002226,+0.0001234,+0.0000671,+0.0000357,
    +0.0000095,+0.0000048,+0.0000024,+0.0000011,+0.0000005,+0.0000002,
    +0.000000,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,
    0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,},
    // H1(u)
    {-1.12838,-1.10596,-1.04048,-0.93703,-0.80346,-0.64945,-0.48582,-0.32192,
    -0.16772,-0.03012,+0.08594,+0.17789,+0.24537,+0.28981,+0.31394,+0.32130,
    +0.31573,+0.30094,+0.28027,+0.25648,+0.231726,+0.207528,+0.184882,+0.164341,
    +0.146128,+0.130236,+0.116515,+0.104739,+0.094653,+0.086005,+0.078565,
    +0.072129,+0.066526,+0.061615,+0.057281,+0.053430,+0.049988,+0.046894,
    +0.044098,+0.041561,+0.039250,+0.035195,+0.031762,+0.028824,+0.026288,
    +0.024081,+0.022146,+0.020441,+0.018929,+0.017582,+0.016375,+0.015291,
    +0.014312,+0.013426,+0.012620,+0.0118860,+0.0112145,+0.0105990,+0.0100332,
    +0.0095119,+0.0090306,+0.0085852,+0.0081722,+0.0077885,+0.0074314,
    +0.0070985,+0.0067875,+0.0064967,+0.0062243,+0.0059688,+0.0057287,
    +0.0055030,+0.0052903,+0.0050898,+0.0049006,+0.0047217,+0.0045526,
    +0.0043924,+0.0042405,+0.0040964,+0.0039595},
    // H2(u)
    {1.0000,+0.9702,+0.8839,+0.7494,+0.5795,+0.3894,+0.1953,+0.0123,-0.1476,
    -0.2758,-0.3679,-0.4234,-0.4454,-0.4392,-0.4113,-0.3689,-0.3185,-0.2657,
    -0.2146,-0.1683,-0.12821,-0.09505,-0.06863,-0.04830,-0.03315,-0.02220,
    -0.01451,-0.00927,-0.00578,-0.00352,-0.00210,-0.00122,-0.00070,-0.00039,
    -0.00021,-0.00011,-0.00006,-0.00003,-0.00001,-0.00001,0.00000,0.,0.,0.,0.,
    0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,
    0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,},
    // H3(u)
    {-0.752,-0.722,-0.637,-0.505,-0.342,-0.165,+0.007,+0.159,+0.280,+0.362,
    +0.405,+0.411,+0.386,+0.339,+0.280,+0.215,+0.153,+0.097,+0.051,+0.015,
    -0.0101,-0.0265,-0.0355,-0.0391,-0.0389,-0.0363,-0.0325,-0.0282,-0.0239,
    -0.0201,-0.0167,-0.0138,-0.0115,-0.0096,-0.0080,-0.0068,-0.0058,-0.0050,
    -0.0043,-0.0037,-0.00329,-0.00257,-0.00205,-0.00166,-0.00137,
    -0.00113,-0.00095,-0.00080,-0.00068,-0.00059,-0.00051,-0.00044,-0.00038,
    -0.00034,-0.00030,-0.00026,-0.00023,-0.00021,-0.00019,-0.00017,-0.00015,
    -0.00013,-0.00012,-0.00011,-0.00010,-0.00009,-0.00008,-0.00008,-0.00007,
    -0.00007,-0.00006,-0.00006,-0.00005,-0.00005,-0.00004,-0.00004,-0.00004,
    -0.00003,-0.00003,-0.00003,-0.00003},
    // H4(u)
    {+0.50,+0.48,+0.40,+0.30,+0.17,+0.03,-0.09,-0.20,-0.27,-0.30,-0.31,-0.28,
    -0.24,-0.18,-0.12,-0.07,-0.02,+0.02,+0.04,+0.05,+0.058,+0.056,+0.051,
    +0.043,+0.035,+0.027,+0.020,+0.015,+0.010,+0.007,+0.005,+0.003,+0.002,
    +0.001,0.001,0.000,0.000,0.000,0.000,0.000,0.000,0.,0.,0.,0.,0.,0.,0.,0.,
    0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.,
    0.,0.,0.,0.,0.,0.,0.,}};